<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Questionário PNATRANS</title>
    <!-- Incluindo o Tailwind CSS para um design moderno -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Incluindo a fonte Roboto do Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* Estilos personalizados com a paleta Amarelo e Preto */
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #f4f4f5; /* Cinza claro (zinc-100) */
        }
        /* Efeito suave de aparição para as perguntas estratégicas */
        .strategic-block {
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            max-height: 0;
            overflow: hidden;
            opacity: 0;
            transform: translateY(-10px);
        }
        .strategic-block.visible {
            max-height: 1500px;
            opacity: 1;
            transform: translateY(0);
        }
        /* Estilos para os botões de rádio customizados */
        .custom-radio-label {
            transition: all 0.2s ease-in-out;
        }
        .custom-radio-label:has(input:checked) {
            background-color: #f59e0b; /* amber-500 */
            color: black;
            border-color: #d97706; /* amber-600 */
        }
        .custom-radio-label:has(input:checked) svg {
            stroke: black;
        }
    </style>
</head>
<body class="text-gray-900">

    <div class="container mx-auto p-4 sm:p-6 md:p-10">
        
        <!-- HEADER PERSONALIZADO -->
        <header class="max-w-3xl mx-auto bg-amber-400 p-6 rounded-xl shadow-lg text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-black">Pesquisa PNATRANS</h1>
            <p class="text-md text-black/80 mt-1">Indicadores de Segurança Viária</p>
        </header>

        <main class="max-w-3xl mx-auto">
            <form id="pnatrans-form" class="space-y-8">
                <!-- Título do Formulário em um card separado -->
                <div class="bg-white p-6 rounded-xl shadow-md border border-gray-200">
                    <h2 class="text-2xl font-bold text-center text-gray-800">Formulário de Coleta</h2>
                    <p class="text-center text-gray-500 mt-1">Preencha os campos abaixo para gerar seu plano de ação.</p>
                </div>
                
                <!-- Container para os pilares e temas (cards) -->
                <div id="questionnaire-container" class="space-y-12"></div>
            </form>

            <div class="mt-12 text-center">
                <button id="submit-btn" class="bg-amber-400 text-black font-bold py-4 px-10 rounded-lg hover:bg-black hover:text-amber-400 transition-all duration-300 shadow-lg hover:shadow-xl transform hover:-translate-y-1 text-lg flex items-center justify-center mx-auto border-2 border-transparent">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    Gerar Plano de Ação
                </button>
            </div>

            <!-- O plano de ação gerado aparecerá aqui -->
            <div id="action-plan-container" class="mt-16 hidden">
                <h2 class="text-3xl font-bold text-center mb-8 text-gray-800">Plano de Ação Sugerido</h2>
                <div id="plan-results" class="bg-white p-6 md:p-8 rounded-xl shadow-xl border border-gray-200">
                    <!-- Conteúdo do plano será inserido aqui -->
                </div>
            </div>
        </main>

        <footer class="text-center mt-16 text-gray-500 text-sm">
            <p>Gerado a partir dos Manuais do Observatório Nacional de Segurança Viária e UFPR.</p>
        </footer>
    </div>

    <script>
        // --- INÍCIO DO JAVASCRIPT ---

        // 1. FONTE DE DADOS: O "cérebro" do formulário com a CRONOLOGIA.
        const formSchema = [
            { "id": "p1_t1_q1", "pilar": "Pilar 1: Gestão da Segurança no Trânsito", "tema": "Banco de dados", "text_pt": "O município possui um banco de dados de sinistros de trânsito?", "level": "basic", "type": "boolean", "cronologia": "1.6", "action_text": "Implantar um banco de dados de sinistros de trânsito" },
            { "id": "p1_t1_q2", "pilar": "Pilar 1: Gestão da Segurança no Trânsito", "tema": "Banco de dados", "text_pt": "O banco de dados de sinistros de trânsito é unificado (possui dados de diferentes órgãos)?", "level": "strategic", "type": "boolean", "cronologia": "2.3", "show_if": ["p1_t1_q1"], "action_text": "Unificar o banco de dados de sinistros de trânsito" },
            { "id": "p1_t1_q3", "pilar": "Pilar 1: Gestão da Segurança no Trânsito", "tema": "Banco de dados", "text_pt": "O município faz análises a partir da utilização de bancos de dados (próprio/estadual/RENAEST)?", "level": "strategic", "type": "boolean", "cronologia": "2.5", "show_if": ["p1_t1_q1"], "action_text": "Realizar análises a partir do banco de dados" },
            { "id": "p1_t2_q1", "pilar": "Pilar 1: Gestão da Segurança no Trânsito", "tema": "Departamento de gestão do trânsito / segurança viária", "text_pt": "O município possui um departamento de segurança no trânsito / gestão do trânsito?", "level": "basic", "type": "boolean", "cronologia": "1.2", "action_text": "Estruturar um departamento de segurança no trânsito" },
            { "id": "p1_t2_q2", "pilar": "Pilar 1: Gestão da Segurança no Trânsito", "tema": "Departamento de gestão do trânsito / segurança viária", "text_pt": "Quantos profissionais capacitados em gestão da segurança viária o município possui?", "level": "strategic", "type": "integer", "cronologia": "2.3", "show_if": ["p1_t2_q1"], "action_text": "Capacitar e/ou ampliar o número de profissionais em gestão de segurança viária" },
            { "id": "p1_t2_q3", "pilar": "Pilar 1: Gestão da Segurança no Trânsito", "tema": "Departamento de gestão do trânsito / segurança viária", "text_pt": "O município possui responsáveis pelo gerenciamento de projetos em prol da segurança viária?", "level": "strategic", "type": "boolean", "cronologia": "2.4", "show_if": ["p1_t2_q1"], "action_text": "Definir responsáveis pelo gerenciamento de projetos de segurança viária" },
            { "id": "p1_t3_q1", "pilar": "Pilar 1: Gestão da Segurança no Trânsito", "tema": "Gestão da Segurança no Trânsito", "text_pt": "O município possui um Plano Diretor?", "level": "basic", "type": "boolean", "cronologia": "1.3", "action_text": "Elaborar ou atualizar o Plano Diretor" },
            { "id": "p1_t3_q2", "pilar": "Pilar 1: Gestão da Segurança no Trânsito", "tema": "Gestão da Segurança no Trânsito", "text_pt": "O município possui um Plano de Mobilidade?", "level": "basic", "type": "boolean", "cronologia": "1.4", "action_text": "Elaborar ou atualizar o Plano de Mobilidade" },
            { "id": "p1_t3_q3", "pilar": "Pilar 1: Gestão da Segurança no Trânsito", "tema": "Gestão da Segurança no Trânsito", "text_pt": "O município estabelece metas de redução relacionadas à segurança viária?", "level": "basic", "type": "boolean", "cronologia": "1.5", "action_text": "Estabelecer metas de redução de sinistros" },
            { "id": "p1_t3_q4", "pilar": "Pilar 1: Gestão da Segurança no Trânsito", "tema": "Gestão da Segurança no Trânsito", "text_pt": "Qual a porcentagem de proprietários e de condutores de veículos aderidos ao SNE (Sistema de Notificação Eletrônica)?", "level": "strategic", "type": "integer", "cronologia": "2.6", "show_if": ["p1_t3_q3"], "action_text": "Promover a adesão ao SNE" },
            { "id": "p1_t4_q1", "pilar": "Pilar 1: Gestão da Segurança no Trânsito", "tema": "Municipalização", "text_pt": "O município está integrado ao Sistema Nacional de Trânsito?", "level": "basic", "type": "boolean", "cronologia": "1.1", "action_text": "Integrar o município ao Sistema Nacional de Trânsito (SNT)" },
            { "id": "p1_t4_q2", "pilar": "Pilar 1: Gestão da Segurança no Trânsito", "tema": "Municipalização", "text_pt": "O município possui quantos agentes de trânsito?", "level": "strategic", "type": "integer", "cronologia": "2.1", "show_if": ["p1_t4_q1"], "action_text": "Ampliar o efetivo de agentes de trânsito" },
            { "id": "p1_t4_q3", "pilar": "Pilar 1: Gestão da Segurança no Trânsito", "tema": "Municipalização", "text_pt": "Realiza operações de fiscalização da Lei Seca?", "level": "strategic", "type": "boolean", "cronologia": "2.2", "show_if": ["p1_t4_q1"], "action_text": "Realizar operações de fiscalização da Lei Seca" },
            { "id": "p1_t4_q4", "pilar": "Pilar 1: Gestão da Segurança no Trânsito", "tema": "Municipalização", "text_pt": "O município possui quantos órgãos e entidades integrados ao SNT que participaram na elaboração de planos estaduais?", "level": "strategic", "type": "integer", "cronologia": "2.3", "show_if": ["p1_t4_q1"], "action_text": "Aumentar a participação de órgãos na elaboração de planos estaduais" },
            { "id": "p2_t1_q1", "pilar": "Pilar 2: Vias Seguras", "tema": "Análise de infrações", "text_pt": "O município possui uma base de dados de infrações no trânsito?", "level": "basic", "type": "boolean", "cronologia": "2.3", "action_text": "Estruturar uma base de dados de infrações de trânsito" },
            { "id": "p2_t1_q2", "pilar": "Pilar 2: Vias Seguras", "tema": "Análise de infrações", "text_pt": "Qual a quantidade de infrações anuais relacionadas à direção sob influência de álcool?", "level": "strategic", "type": "integer", "cronologia": "2.4", "show_if": ["p2_t1_q1"], "action_text": "Analisar e criar ações para reduzir infrações por alcoolemia" },
            { "id": "p2_t1_q3", "pilar": "Pilar 2: Vias Seguras", "tema": "Análise de infrações", "text_pt": "Qual a quantidade de infrações anuais relacionadas ao excesso de velocidade?", "level": "strategic", "type": "integer", "cronologia": "2.4", "show_if": ["p2_t1_q1"], "action_text": "Analisar e criar ações para reduzir infrações por excesso de velocidade" },
            { "id": "p2_t1_q4", "pilar": "Pilar 2: Vias Seguras", "tema": "Análise de infrações", "text_pt": "Qual a quantidade de infrações anuais relacionadas ao não uso do capacete?", "level": "strategic", "type": "integer", "cronologia": "2.4", "show_if": ["p2_t1_q1"], "action_text": "Analisar e criar ações para aumentar o uso de capacete" },
            { "id": "p2_t1_q5", "pilar": "Pilar 2: Vias Seguras", "tema": "Análise de infrações", "text_pt": "Qual a quantidade de infrações anuais relacionadas ao uso do telefone celular?", "level": "strategic", "type": "integer", "cronologia": "2.4", "show_if": ["p2_t1_q1"], "action_text": "Analisar e criar ações para reduzir o uso de celular na direção" },
            { "id": "p2_t1_q6", "pilar": "Pilar 2: Vias Seguras", "tema": "Análise de infrações", "text_pt": "Qual a quantidade de infrações anuais relacionadas ao não uso de sistema de retenção para criança (cadeirinha)?", "level": "strategic", "type": "integer", "cronologia": "2.5", "show_if": ["p2_t1_q1"], "action_text": "Analisar e criar ações para aumentar o uso da cadeirinha" },
            { "id": "p2_t1_q7", "pilar": "Pilar 2: Vias Seguras", "tema": "Análise de infrações", "text_pt": "Qual a quantidade de infrações anuais relacionadas ao não uso do cinto de segurança?", "level": "strategic", "type": "integer", "cronologia": "2.5", "show_if": ["p2_t1_q1"], "action_text": "Analisar e criar ações para aumentar o uso do cinto de segurança" },
            { "id": "p2_t2_q1", "pilar": "Pilar 2: Vias Seguras", "tema": "Desenho viário", "text_pt": "O município aplica padrões de desenho viário e gestão da velocidade em áreas escolares?", "level": "basic", "type": "boolean", "cronologia": "1.7", "action_text": "Aplicar padrões de desenho viário e gestão da velocidade em áreas escolares" },
            { "id": "p2_t2_q2", "pilar": "Pilar 2: Vias Seguras", "tema": "Desenho viário", "text_pt": "O município aplica padrões de desenho viário para usuários vulneráveis?", "level": "basic", "type": "boolean", "cronologia": "1.7", "action_text": "Aplicar padrões de desenho viário para usuários vulneráveis" },
            { "id": "p2_t2_q3", "pilar": "Pilar 2: Vias Seguras", "tema": "Desenho viário", "text_pt": "O município participa do Programa Ruas Completas?", "level": "basic", "type": "boolean", "cronologia": "1.7", "action_text": "Participar do Programa Ruas Completas" },
            { "id": "p2_t2_q4", "pilar": "Pilar 2: Vias Seguras", "tema": "Desenho viário", "text_pt": "O município possui técnicos e projetistas capacitados no Manual Brasileiro de Auditorias e Inspeções de Segurança Viária?", "level": "basic", "type": "boolean", "cronologia": "1.8", "action_text": "Capacitar técnicos e projetistas no Manual de Auditorias e Inspeções" },
            { "id": "p2_t2_q5", "pilar": "Pilar 2: Vias Seguras", "tema": "Desenho viário", "text_pt": "O município possui quantos técnicos capacitados neste manual?", "level": "strategic", "type": "integer", "cronologia": "2.6", "show_if": ["p2_t2_q4"], "action_text": "Aumentar o número de técnicos capacitados no Manual" },
            { "id": "p2_t3_q1", "pilar": "Pilar 2: Vias Seguras", "tema": "Investimento", "text_pt": "O município possui políticas de investimento em mobilidade não-motorizada?", "level": "basic", "type": "boolean", "cronologia": "1.7", "action_text": "Criar políticas de investimento em mobilidade não-motorizada" },
            { "id": "p2_t3_q2", "pilar": "Pilar 2: Vias Seguras", "tema": "Investimento", "text_pt": "O município possui políticas de investimento em transporte público?", "level": "basic", "type": "boolean", "cronologia": "1.7", "action_text": "Criar políticas de investimento em transporte público" },
            { "id": "p2_t4_q1", "pilar": "Pilar 2: Vias Seguras", "tema": "Mapeamento", "text_pt": "O município efetua o mapeamento de pontos críticos de sinistros?", "level": "basic", "type": "boolean", "cronologia": "2.1", "action_text": "Efetuar o mapeamento de pontos críticos de sinistros" },
            { "id": "p2_t4_q2", "pilar": "Pilar 2: Vias Seguras", "tema": "Mapeamento", "text_pt": "O município efetua o mapeamento do nível de conservação e características das vias?", "level": "basic", "type": "boolean", "cronologia": "2.2", "action_text": "Mapear o nível de conservação e características das vias" },
            { "id": "p3_t1_q1", "pilar": "Pilar 3: Segurança Veicular", "tema": "Características da frota", "text_pt": "Qual a quantidade de caminhões, em %, na frota do município?", "level": "basic", "type": "integer", "cronologia": "-", "action_text": "Analisar o perfil da frota de caminhões" },
            { "id": "p3_t1_q2", "pilar": "Pilar 3: Segurança Veicular", "tema": "Características da frota", "text_pt": "Qual a quantidade de veículo de duas rodas, em %, na frota do município?", "level": "basic", "type": "integer", "cronologia": "-", "action_text": "Analisar o perfil da frota de duas rodas" },
            { "id": "p3_t1_q3", "pilar": "Pilar 3: Segurança Veicular", "tema": "Características da frota", "text_pt": "Qual a idade média da frota?", "level": "strategic", "type": "integer", "cronologia": "2.3", "show_if": ["p3_t1_q1", "p3_t1_q2"], "action_text": "Analisar a idade média da frota e criar políticas de renovação" },
            { "id": "p3_t2_q1", "pilar": "Pilar 3: Segurança Veicular", "tema": "Inspeções veiculares", "text_pt": "O município faz inspeções veiculares de segurança?", "level": "basic", "type": "boolean", "cronologia": "1.8", "action_text": "Implementar inspeções veiculares de segurança" },
            { "id": "p3_t2_q2", "pilar": "Pilar 3: Segurança Veicular", "tema": "Inspeções veiculares", "text_pt": "O município faz inspeções veiculares de emissões (ambiental)?", "level": "basic", "type": "boolean", "cronologia": "1.9", "action_text": "Implementar inspeções veiculares de emissões (ambiental)" },
            { "id": "p3_t2_q3", "pilar": "Pilar 3: Segurança Veicular", "tema": "Inspeções veiculares", "text_pt": "O município efetua inspeções veiculares de segurança com qual frequência?", "level": "strategic", "type": "text", "cronologia": "2.1", "show_if": ["p3_t2_q1"], "action_text": "Aumentar a frequência de inspeções de segurança" },
            { "id": "p3_t2_q4", "pilar": "Pilar 3: Segurança Veicular", "tema": "Inspeções veiculares", "text_pt": "O município efetua inspeções veiculares de emissões com qual frequência?", "level": "strategic", "type": "text", "cronologia": "2.2", "show_if": ["p3_t2_q2"], "action_text": "Aumentar a frequência de inspeções de emissões" },
            { "id": "p4_t1_q1", "pilar": "Pilar 4: Educação para o Trânsito", "tema": "Campanhas educativas", "text_pt": "O município efetua campanhas educativas para o trânsito?", "level": "basic", "type": "boolean", "cronologia": "1.7", "action_text": "Realizar campanhas educativas para o trânsito" },
            { "id": "p4_t1_q2", "pilar": "Pilar 4: Educação para o Trânsito", "tema": "Campanhas educativas", "text_pt": "O município possui parcerias com a iniciativa privada e ONGs para a produção e disseminação de materiais e campanhas educativas?", "level": "strategic", "type": "boolean", "cronologia": "2.1", "show_if": ["p4_t1_q1"], "action_text": "Firmar parcerias para campanhas educativas" },
            { "id": "p4_t1_q3", "pilar": "Pilar 4: Educação para o Trânsito", "tema": "Campanhas educativas", "text_pt": "Quantas campanhas publicitárias foram circuladas voltadas à educação para o trânsito no último ano?", "level": "strategic", "type": "integer", "cronologia": "2.1", "show_if": ["p4_t1_q1"], "action_text": "Aumentar o número de campanhas publicitárias sobre trânsito" },
            { "id": "p4_t1_q4", "pilar": "Pilar 4: Educação para o Trânsito", "tema": "Campanhas educativas", "text_pt": "Quais tipos de mídia o município emprega nas campanhas educativas para o trânsito?", "level": "strategic", "type": "text", "cronologia": "2.2", "show_if": ["p4_t1_q1"], "action_text": "Diversificar as mídias utilizadas nas campanhas" },
            { "id": "p4_t2_q1", "pilar": "Pilar 4: Educação para o Trânsito", "tema": "Educação nas escolas", "text_pt": "O município possui professores da rede de educação básica capacitados na educação para o trânsito?", "level": "basic", "type": "boolean", "cronologia": "1.8", "action_text": "Capacitar professores em educação para o trânsito" },
            { "id": "p4_t2_q2", "pilar": "Pilar 4: Educação para o Trânsito", "tema": "Educação nas escolas", "text_pt": "As escolas municipais adotam material didático (livros) de educação para o trânsito?", "level": "basic", "type": "boolean", "cronologia": "1.8", "action_text": "Adotar material didático de educação para o trânsito nas escolas" },
            { "id": "p4_t2_q3", "pilar": "Pilar 4: Educação para o Trânsito", "tema": "Educação nas escolas", "text_pt": "As escolas municipais possuem disciplinas/ementas envolvendo a educação para o trânsito?", "level": "basic", "type": "boolean", "cronologia": "1.8", "action_text": "Incluir a educação para o trânsito nas disciplinas escolares" },
            { "id": "p4_t2_q4", "pilar": "Pilar 4: Educação para o Trânsito", "tema": "Educação nas escolas", "text_pt": "O município possui projetos que estimulem a vivência do trânsito no ambiente escolar?", "level": "basic", "type": "boolean", "cronologia": "1.9", "action_text": "Criar projetos de vivência do trânsito no ambiente escolar" },
            { "id": "p4_t2_q5", "pilar": "Pilar 4: Educação para o Trânsito", "tema": "Educação nas escolas", "text_pt": "O município possui quantos professores da rede de educação básica capacitados na educação para o trânsito?", "level": "strategic", "type": "integer", "cronologia": "2.1", "show_if": ["p4_t2_q1"], "action_text": "Aumentar o número de professores capacitados em educação para o trânsito" },
            { "id": "p5_t1_q1", "pilar": "Pilar 5: Atendimento às Vítimas", "tema": "Atendimento às vítimas", "text_pt": "O município possui médicos especializados em emergência e trauma?", "level": "basic", "type": "boolean", "cronologia": "1.7", "action_text": "Garantir a presença de médicos especializados em emergência e trauma" },
            { "id": "p5_t1_q2", "pilar": "Pilar 5: Atendimento às Vítimas", "tema": "Atendimento às vítimas", "text_pt": "O município possui unidades do SAMU?", "level": "basic", "type": "boolean", "cronologia": "1.7", "action_text": "Implantar ou ampliar unidades do SAMU" },
            { "id": "p5_t1_q3", "pilar": "Pilar 5: Atendimento às Vítimas", "tema": "Atendimento às vítimas", "text_pt": "O município possui unidades de pronto-socorro?", "level": "basic", "type": "boolean", "cronologia": "1.7", "action_text": "Implantar ou ampliar unidades de pronto-socorro" },
            { "id": "p5_t1_q4", "pilar": "Pilar 5: Atendimento às Vítimas", "tema": "Atendimento às vítimas", "text_pt": "O município possui leitos de UTI?", "level": "basic", "type": "boolean", "cronologia": "1.8", "action_text": "Implantar ou ampliar leitos de UTI" },
            { "id": "p5_t1_q5", "pilar": "Pilar 5: Atendimento às Vítimas", "tema": "Atendimento às vítimas", "text_pt": "O município possui unidades de pronto atendimento ao longo de rodovias?", "level": "basic", "type": "boolean", "cronologia": "1.9", "action_text": "Implantar unidades de pronto atendimento ao longo de rodovias" },
            { "id": "p5_t1_q6", "pilar": "Pilar 5: Atendimento às Vítimas", "tema": "Atendimento às vítimas", "text_pt": "O município possui quantos médicos especializados em emergência e trauma?", "level": "strategic", "type": "integer", "cronologia": "2.1", "show_if": ["p5_t1_q1"], "action_text": "Aumentar o número de médicos especializados" },
            { "id": "p5_t1_q7", "pilar": "Pilar 5: Atendimento às Vítimas", "tema": "Atendimento às vítimas", "text_pt": "Quantas unidades do SAMU o município possui?", "level": "strategic", "type": "integer", "cronologia": "2.1", "show_if": ["p5_t1_q2"], "action_text": "Aumentar o número de unidades do SAMU" },
            { "id": "p5_t1_q8", "pilar": "Pilar 5: Atendimento às Vítimas", "tema": "Atendimento às vítimas", "text_pt": "O município possui quantas unidades de pronto-socorro?", "level": "strategic", "type": "integer", "cronologia": "2.1", "show_if": ["p5_t1_q3"], "action_text": "Aumentar o número de unidades de pronto-socorro" },
            { "id": "p5_t1_q9", "pilar": "Pilar 5: Atendimento às Vítimas", "tema": "Atendimento às vítimas", "text_pt": "Quantos leitos de UTI o município possui?", "level": "strategic", "type": "integer", "cronologia": "2.2", "show_if": ["p5_t1_q4"], "action_text": "Aumentar o número de leitos de UTI" },
            { "id": "p5_t1_q10", "pilar": "Pilar 5: Atendimento às Vítimas", "tema": "Atendimento às vítimas", "text_pt": "O município possui quantas unidades de pronto atendimento ao longo de rodovias?", "level": "strategic", "type": "integer", "cronologia": "2.2", "show_if": ["p5_t1_q5"], "action_text": "Aumentar o número de unidades de pronto atendimento em rodovias" },
            { "id": "p5_t1_q11", "pilar": "Pilar 5: Atendimento às Vítimas", "tema": "Atendimento às vítimas", "text_pt": "O município possui bases de resgate aeromédico?", "level": "strategic", "type": "boolean", "cronologia": "2.3", "show_if": ["p5_t1_q1", "p5_t1_q2"], "action_text": "Implantar bases de resgate aeromédico" },
            { "id": "p6_t1_q1", "pilar": "Pilar 6: Normatização e Fiscalização", "tema": "Fiscalização", "text_pt": "Qual o maior limite de velocidade estabelecido nas vias urbanas (em km/h)?", "level": "basic", "type": "integer", "cronologia": "1.7", "action_text": "Revisar e adequar os limites de velocidade nas vias urbanas" },
            { "id": "p6_t1_q2", "pilar": "Pilar 6: Normatização e Fiscalização", "tema": "Fiscalização", "text_pt": "O município possui equipamentos de fiscalização eletrônica instalados?", "level": "basic", "type": "boolean", "cronologia": "1.8", "action_text": "Instalar equipamentos de fiscalização eletrônica" },
            { "id": "p6_t1_q3", "pilar": "Pilar 6: Normatização e Fiscalização", "tema": "Fiscalização", "text_pt": "O município possui equipamentos de fiscalização eletrônica de velocidade instalados?", "level": "strategic", "type": "boolean", "cronologia": "2.1", "show_if": ["p6_t1_q2"], "action_text": "Instalar fiscalização eletrônica de velocidade" },
            { "id": "p6_t1_q4", "pilar": "Pilar 6: Normatização e Fiscalização", "tema": "Fiscalização", "text_pt": "O município possui equipamentos de fiscalização eletrônica de avanço de sinal vermelho instalados?", "level": "strategic", "type": "boolean", "cronologia": "2.1", "show_if": ["p6_t1_q2"], "action_text": "Instalar fiscalização eletrônica de avanço de sinal vermelho" },
            { "id": "p6_t1_q5", "pilar": "Pilar 6: Normatização e Fiscalização", "tema": "Fiscalização", "text_pt": "O município possui equipamentos de fiscalização eletrônica de parada sobre a faixa de pedestre instalados?", "level": "strategic", "type": "boolean", "cronologia": "2.2", "show_if": ["p6_t1_q2"], "action_text": "Instalar fiscalização de parada sobre a faixa de pedestres" }
        ];

        // 2. FUNÇÃO PARA MONTAR O FORMULÁRIO NA TELA
        function renderQuestionnaire() {
            const container = document.getElementById('questionnaire-container');
            if (!container) return;
            container.innerHTML = ''; 

            const groupedByPilar = formSchema.reduce((acc, q) => {
                if (!acc[q.pilar]) {
                    acc[q.pilar] = {};
                }
                if (!acc[q.pilar][q.tema]) {
                    acc[q.pilar][q.tema] = [];
                }
                acc[q.pilar][q.tema].push(q);
                return acc;
            }, {});

            for (const pilarName in groupedByPilar) {
                const pilarSection = document.createElement('div');
                pilarSection.className = 'space-y-8';
                
                const pilarTitle = document.createElement('h2');
                pilarTitle.className = 'text-2xl font-bold text-gray-800 pt-4';
                pilarTitle.textContent = pilarName;
                pilarSection.appendChild(pilarTitle);

                for (const temaName in groupedByPilar[pilarName]) {
                    const temaCard = document.createElement('div');
                    temaCard.className = 'bg-white p-6 sm:p-8 rounded-xl shadow-md border-t-4 border-amber-400';
                    
                    const temaTitle = document.createElement('h3');
                    temaTitle.className = 'text-xl font-bold text-gray-800 pb-3 mb-4';
                    temaTitle.textContent = temaName;
                    temaCard.appendChild(temaTitle);

                    const questions = groupedByPilar[pilarName][temaName];
                    const basicQuestions = questions.filter(q => q.level === 'basic');
                    const strategicQuestions = questions.filter(q => q.level === 'strategic');

                    basicQuestions.forEach(q => {
                        temaCard.appendChild(createQuestionElement(q));
                    });
                    
                    if (strategicQuestions.length > 0) {
                        // CORREÇÃO AQUI: Agrupa as perguntas estratégicas pela exata dependência
                        const groupedStrategics = strategicQuestions.reduce((acc, sq) => {
                            const key = (sq.show_if || []).join('-');
                            if (!acc[key]) acc[key] = [];
                            acc[key].push(sq);
                            return acc;
                        }, {});

                        for (const key in groupedStrategics) {
                            const questionsInGroup = groupedStrategics[key];
                            
                            const strategicContainer = document.createElement('div');
                            strategicContainer.id = `strategic-container-${key}`;
                            strategicContainer.className = 'strategic-block border-t-2 border-dashed border-gray-200 mt-6 pt-6';
                            
                            const strategicBadge = `<div class="mb-4"><span class="inline-block bg-amber-100 text-amber-800 text-sm font-semibold px-3 py-1 rounded-full">Nível Estratégico</span></div>`;
                            strategicContainer.innerHTML = strategicBadge;

                            questionsInGroup.forEach(q => {
                                 strategicContainer.appendChild(createQuestionElement(q));
                            });
                            
                            const warningMessage = document.createElement('div');
                            warningMessage.id = `warning-${key}`;
                            warningMessage.className = "hidden mt-4 p-3 bg-red-100 border-l-4 border-red-500 text-red-800 rounded-r-lg text-sm";
                            warningMessage.innerHTML = `<p class="font-medium">Atenção: As ações estratégicas deste tópico serão marcadas como "APLICAR" no seu Plano de Ação.</p>`;

                            temaCard.appendChild(warningMessage);
                            temaCard.appendChild(strategicContainer);
                        }
                    }
                    pilarSection.appendChild(temaCard);
                }
                container.appendChild(pilarSection);
            }
        }

        // 3. FUNÇÃO AUXILIAR PARA CRIAR CADA PERGUNTA (HTML)
        function createQuestionElement(question) {
            const questionWrapper = document.createElement('div');
            questionWrapper.className = 'py-4 first:pt-0 last:pb-0';
            
            let inputHtml = '';
            const questionTitle = `<h4 class="text-lg font-semibold text-gray-800">${question.text_pt}</h4>`;

            if (question.type === 'boolean') {
                inputHtml = `
                    <div class="flex flex-col sm:flex-row items-center space-y-2 sm:space-y-0 sm:space-x-4 mt-3">
                        <label class="custom-radio-label flex w-full items-center justify-center cursor-pointer p-3 border-2 border-gray-300 rounded-lg hover:border-amber-500">
                            <input type="radio" name="${question.id}" value="true" class="sr-only">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" /></svg>
                            <span class="font-semibold">Sim</span>
                        </label>
                        <label class="custom-radio-label flex w-full items-center justify-center cursor-pointer p-3 border-2 border-gray-300 rounded-lg hover:border-amber-500">
                            <input type="radio" name="${question.id}" value="false" class="sr-only">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                            <span class="font-semibold">Não</span>
                        </label>
                    </div>
                `;
            } else if (question.type === 'integer' || question.type === 'text') {
                 let placeholder = question.type === 'integer' ? '0' : 'Descreva aqui...';
                 let inputType = question.type === 'integer' ? 'number' : 'text';
                 let maxWidth = question.type === 'integer' ? 'max-w-xs' : 'max-w-md';
                 inputHtml = `<input type="${inputType}" name="${question.id}" ${inputType === 'number' ? 'min="0"' : ''} class="mt-3 w-full ${maxWidth} bg-gray-50 px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500 transition" placeholder="${placeholder}">`;
            }

            questionWrapper.innerHTML = questionTitle + inputHtml;
            return questionWrapper;
        }
        
        // 4. LÓGICA CONDICIONAL EM AÇÃO
        function handleConditionalLogic() {
            const dependenciesMap = new Map();
            formSchema.filter(q => q.level === 'strategic' && q.show_if).forEach(q => {
                const key = q.show_if.join('-');
                if (!dependenciesMap.has(key)) dependenciesMap.set(key, q.show_if);
            });

            dependenciesMap.forEach((basicDependencies, key) => {
                const allBasicsTrue = basicDependencies.every(id => document.querySelector(`input[name="${id}"][value="true"]`)?.checked);
                const anyBasicAnsweredFalse = basicDependencies.some(id => document.querySelector(`input[name="${id}"][value="false"]`)?.checked);
                
                const strategicContainer = document.getElementById(`strategic-container-${key}`);
                const warningMessage = document.getElementById(`warning-${key}`);

                if (strategicContainer && warningMessage) {
                    strategicContainer.classList.toggle('visible', allBasicsTrue);
                    warningMessage.classList.toggle('hidden', !anyBasicAnsweredFalse || allBasicsTrue);
                }
            });
        }
        
        // 5. FUNÇÃO PARA GERAR O PLANO DE AÇÃO
        function generateActionPlan(event) {
            event.preventDefault();
            const form = document.getElementById('pnatrans-form');
            
            const formData = new FormData(form);
            const answers = Object.fromEntries(formData.entries());
            const plan = [];
            const answeredBasics = {};

            formSchema.filter(q => q.level === 'basic').forEach(q => {
                let answer = false;
                if (q.type === 'boolean') answer = answers[q.id] === 'true';
                else if (['integer', 'text'].includes(q.type)) {
                    const value = answers[q.id];
                    answer = value && value.trim() !== ''; 
                }
                
                answeredBasics[q.id] = answer;
                
                let status = 'APLICAR';
                if (q.type === 'boolean') {
                    status = answer ? 'OK' : 'APLICAR';
                } else if (['integer', 'text'].includes(q.type)) {
                    status = (answers[q.id] && (parseInt(answers[q.id], 10) || 0) > 0) || (answers[q.id] && answers[q.id].trim() !== '') ? 'OK' : 'APLICAR';
                }
                plan.push({ action_text: q.action_text, status: status, pilar: q.pilar, level: q.level, cronologia: q.cronologia });
            });

            formSchema.filter(q => q.level === 'strategic').forEach(q => {
                const areBasicsOk = (q.show_if || []).every(id => answeredBasics[id]);
                let status = 'APLICAR';
                let details = '';

                if (!areBasicsOk) {
                    details = 'Ação estratégica recomendada pois o requisito básico não foi atendido.';
                } else {
                    if (q.type === 'boolean') {
                        status = (answers[q.id] === 'true') ? 'OK' : 'APLICAR';
                    } else if (['integer', 'text'].includes(q.type)) {
                        const value = answers[q.id] || '';
                        status = value.trim() !== '' && (parseInt(value,10) || 0) > 0 || (q.type === 'text' && value.trim() !== '') ? 'OK' : 'APLICAR';
                        details = `Informação fornecida: "${value}".`;
                    }
                }
                plan.push({ action_text: q.action_text, status, details, pilar: q.pilar, level: q.level, cronologia: q.cronologia });
            });
            renderPlan(plan);
        }

        // 6. FUNÇÃO PARA MOSTRAR O PLANO DE AÇÃO NA TELA (COM CRONOLOGIA)
        function renderPlan(plan) {
            const container = document.getElementById('action-plan-container');
            const resultsDiv = document.getElementById('plan-results');
            if (!container || !resultsDiv) return;
            
            // Tenta pegar o nome do município do sessionStorage
            const municipioInfo = JSON.parse(sessionStorage.getItem('municipioInfo') || '{}');
            const municipioName = municipioInfo.municipio || 'Não informado';

            const groupedByPilar = plan.reduce((acc, action) => {
                (acc[action.pilar] = acc[action.pilar] || []).push(action);
                return acc;
            }, {});

            resultsDiv.innerHTML = `<h3 class="text-2xl font-bold text-gray-800 mb-6">Município: ${municipioName}</h3>`;

            for(const pilarName in groupedByPilar) {
                let pilarActions = groupedByPilar[pilarName];

                // Ordena as ações pela cronologia
                pilarActions.sort((a, b) => {
                    const cronA = a.cronologia || '99.99';
                    const cronB = b.cronologia || '99.99';
                    return cronA.localeCompare(cronB, undefined, { numeric: true });
                });

                const actionsToApply = pilarActions.filter(a => a.status === 'APLICAR');
                const actionsOk = pilarActions.filter(a => a.status === 'OK');

                const pilarTitle = `<h4 class="text-xl font-semibold text-amber-700 border-b border-gray-200 pb-2 mb-4">${pilarName}</h4>`;
                let listHtml = '';
                
                if (actionsToApply.length > 0) {
                    listHtml += `<div class="mb-6">
                                    <h5 class="text-lg font-bold text-gray-700 mb-3">Ações Prioritárias (A Aplicar)</h5>
                                    <ul class="space-y-4">
                                        ${actionsToApply.map(action => createActionListItem(action)).join('')}
                                    </ul>
                                 </div>`;
                }

                if (actionsOk.length > 0) {
                     listHtml += `<div class="mt-8">
                                    <h5 class="text-lg font-bold text-gray-700 mb-3">Ações Já Cumpridas (OK)</h5>
                                    <ul class="space-y-4">
                                        ${actionsOk.map(action => createActionListItem(action)).join('')}
                                    </ul>
                                 </div>`;
                }
                
                resultsDiv.innerHTML += `<div class="mb-8 last:mb-0">${pilarTitle}${listHtml}</div>`;
            }

            container.classList.remove('hidden');
            container.scrollIntoView({ behavior: 'smooth' });
        }

        function createActionListItem(action) {
            const levelBadge = `<span class="text-xs font-semibold px-2 py-0.5 rounded-full ${action.level === 'basic' ? 'bg-blue-100 text-blue-800' : 'bg-purple-100 text-purple-800'}">${action.level === 'basic' ? 'Básico' : 'Estratégico'}</span>`;
            
            return `
                <li class="flex items-start">
                    <span class="mr-4 mt-1 flex-shrink-0 h-6 w-6 flex items-center justify-center rounded-full ${action.status === 'OK' ? 'bg-green-500' : 'bg-amber-500'}">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3">
                            ${action.status === 'OK' ? '<path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />' : '<path stroke-linecap="round" stroke-linejoin="round" d="M12 4v1m0 8v8m-4-4h8" />'}
                        </svg>
                    </span>
                    <div>
                        <p class="font-medium text-gray-700">${action.action_text}</p>
                        <div class="flex items-center space-x-2 mt-1">
                            <span class="text-xs font-semibold px-2 py-0.5 rounded-full ${action.status === 'OK' ? 'bg-green-100 text-green-800' : 'bg-amber-100 text-amber-800'}">
                                ${action.status === 'OK' ? 'CUMPRIDO' : 'APLICAR'}
                            </span>
                            ${levelBadge}
                        </div>
                        ${action.details ? `<p class="text-xs text-gray-500 mt-1">${action.details}</p>` : ''}
                    </div>
                </li>
            `;
        }
        
        // Inicialização do formulário
        document.addEventListener('DOMContentLoaded', function() {
            renderQuestionnaire();
            document.getElementById('pnatrans-form').addEventListener('change', handleConditionalLogic);
            document.getElementById('submit-btn').addEventListener('click', generateActionPlan);
        });

    </script>
</body>
</html>
